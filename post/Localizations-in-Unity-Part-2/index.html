<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    
    <meta itemprop="name" content="Localizations in Unity: Part 2 | jaredbarboza.me">
    <meta itemprop="description" content="üçï P I Z Z A is life">

    
    <meta name="twitter:title" content="Localizations in Unity: Part 2 | jaredbarboza.me">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="üçï P I Z Z A is life">
    <meta name="twitter:site" content="@codeimpossible">
    <meta name="twitter:creator" content="@codeimpossible">
    <meta name="twitter:image:src" content="http://jaredbarboza.me/social-header.png">

    
    <meta name="og:title" content="Localizations in Unity: Part 2 | jaredbarboza.me">
    <meta name="og:description" content="üçï P I Z Z A is life">
    <meta name="og:image" content="http://jaredbarboza.me/social-header-lg.png">
    <meta name="og:url" content="http://jaredbarboza.me/">
    <meta name="og:site_name" content="jaredbarboza.me">
    <meta name="og:locale" content="en_US">
    <meta name="og:type" content="website">

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <title>Localizations in Unity: Part 2‚Äîjaredbarboza.me</title>

    <link rel="stylesheet" href="/assets/main.bundle.css">

    
  </head>
  <body class="flex flex-col min-h-screen is-post">
    <!-- <p class="top-notice">
    Include a notice here!
</p> -->

    <main class="container mx-auto max-w-3xl flex-grow">
      <aside class="intro">
  <a href="/">
    <img src="/me.jpg" alt="Me. I mean Jared. I mean that's me, Jared." class="rounded-full" />
  </a>
  <div class="intro-greeting mb-5">
    <h1>Hey there üëã, I'm Jared.</h1>
    <h2>Future skeleton. üêà parent. Lover of all things üçï. Dispenser of artisanal emoji, gifs and memes. They/Them.</h2>
  </div>
  <span class="social">
      <a href="https://twitter.com/codeimpossible" class="social_icon icon-twitter" title="@codeimpossible on Twitter">
          <svg width="28" height="28" viewBox="0 0 32 32" preserveAspectRatio="xMinYMin" aria-hidden="true" focusable="false">
              <use xlink:href="#icon-twitter">
                  <g id="icon-twitter"><path fill="#00c9ff" d="M 32,6.076c-1.177,0.522-2.443,0.875-3.771,1.034c 1.355-0.813, 2.396-2.099, 2.887-3.632 c-1.269,0.752-2.674,1.299-4.169,1.593c-1.198-1.276-2.904-2.073-4.792-2.073c-3.626,0-6.565,2.939-6.565,6.565 c0,0.515, 0.058,1.016, 0.17,1.496c-5.456-0.274-10.294-2.888-13.532-6.86c-0.565,0.97-0.889,2.097-0.889,3.301 c0,2.278, 1.159,4.287, 2.921,5.465c-1.076-0.034-2.088-0.329-2.974-0.821c-0.001,0.027-0.001,0.055-0.001,0.083 c0,3.181, 2.263,5.834, 5.266,6.438c-0.551,0.15-1.131,0.23-1.73,0.23c-0.423,0-0.834-0.041-1.235-0.118 c 0.836,2.608, 3.26,4.506, 6.133,4.559c-2.247,1.761-5.078,2.81-8.154,2.81c-0.53,0-1.052-0.031-1.566-0.092 c 2.905,1.863, 6.356,2.95, 10.064,2.95c 12.076,0, 18.679-10.004, 18.679-18.68c0-0.285-0.006-0.568-0.019-0.849 C 30.007,8.548, 31.12,7.392, 32,6.076z"></path></g>
              </use>
          </svg>
          <span class="a11y-only">Twitter</span>
      </a> 
      <a href="https://github.com/codeimpossible/" class="social_icon icon-github" title="@codeimpossible on GitHub">
          <svg width="28" height="28" viewBox="0 0 32 32" preserveAspectRatio="xMinYMin" aria-hidden="true" focusable="false">
              <use xlink:href="#icon-github">
                  <g id="icon-github"><path fill="#000000" d="M 16,0C 7.163,0,0,7.163,0,16s 7.163,16, 16,16s 16-7.163, 16-16S 24.837,0, 16,0z M 25.502,25.502 c-1.235,1.235-2.672,2.204-4.272,2.881c-0.406,0.172-0.819,0.323-1.238,0.453L 19.992,26.438 c0-1.26-0.432-2.188-1.297-2.781 c 0.542-0.052, 1.039-0.125, 1.492-0.219s 0.932-0.229, 1.438-0.406s 0.958-0.388, 1.359-0.633s 0.786-0.563, 1.156-0.953s 0.68-0.833, 0.93-1.328 s 0.448-1.089, 0.594-1.781s 0.219-1.456, 0.219-2.289c0-1.615-0.526-2.99-1.578-4.125c 0.479-1.25, 0.427-2.609-0.156-4.078l-0.391-0.047 c-0.271-0.031-0.758,0.083-1.461,0.344s-1.492,0.688-2.367,1.281c-1.24-0.344-2.526-0.516-3.859-0.516c-1.344,0-2.625,0.172-3.844,0.516 c-0.552-0.375-1.075-0.685-1.57-0.93c-0.495-0.245-0.891-0.411-1.188-0.5s-0.573-0.143-0.828-0.164s-0.419-0.026-0.492-0.016 s-0.125,0.021-0.156,0.031c-0.583,1.479-0.635,2.839-0.156,4.078c-1.052,1.135-1.578,2.51-1.578,4.125c0,0.833, 0.073,1.596, 0.219,2.289 s 0.344,1.286, 0.594,1.781s 0.56,0.938, 0.93,1.328s 0.755,0.708, 1.156,0.953s 0.854,0.456, 1.359,0.633s 0.984,0.313, 1.438,0.406 s 0.951,0.167, 1.492,0.219c-0.854,0.583-1.281,1.51-1.281,2.781l0,2.445 c-0.472-0.14-0.937-0.306-1.394-0.5 c-1.6-0.677-3.037-1.646-4.272-2.881c-1.235-1.235-2.204-2.672-2.881-4.272C 2.917,19.575, 2.563,17.815, 2.563,16 s 0.355-3.575, 1.055-5.23c 0.677-1.6, 1.646-3.037, 2.881-4.272s 2.672-2.204, 4.272-2.881 C 12.425,2.917, 14.185,2.563, 16,2.563s 3.575,0.355, 5.23,1.055c 1.6,0.677, 3.037,1.646, 4.272,2.881 c 1.235,1.235, 2.204,2.672, 2.881,4.272C 29.083,12.425, 29.438,14.185, 29.438,16s-0.355,3.575-1.055,5.23 C 27.706,22.829, 26.737,24.267, 25.502,25.502z"></path></g>
              </use>
          </svg>
          <span class="a11y-only">GitHub</span>
      </a> 
      <a href="/feed/" class="social_icon icon-rss" title="Jared Barboza's RSS Feed">
          <svg width="28" height="28" viewBox="0 0 32 32" preserveAspectRatio="xMinYMin" aria-hidden="true" focusable="false">
              <use xlink:href="#icon-feed">
                  <g id="icon-feed"><path fill="#ff9132" d="M 4.259,23.467c-2.35,0-4.259,1.917-4.259,4.252c0,2.349, 1.909,4.244, 4.259,4.244 c 2.358,0, 4.265-1.895, 4.265-4.244C 8.525,25.383, 6.618,23.467, 4.259,23.467zM 0.005,10.873l0,6.133 c 3.993,0, 7.749,1.562, 10.577,4.391c 2.825,2.822, 4.384,6.595, 4.384,10.603l 6.16,0 C 21.125,20.349, 11.648,10.873, 0.005,10.873zM 0.012,0l0,6.136 c 14.243,0, 25.836,11.604, 25.836,25.864L 32,32 C 32,14.36, 17.648,0, 0.012,0z"></path></g>
              </use>
          </svg>
          <span class="a11y-only">RSS</span>
      </a>
  </span>
</aside>


<!--<header>
  <nav class="container mx-auto max-w-3xl px-8 pt-2 flex flex-wrap justify-between">
    <div>
      <h1 class="header-title">
        <a href="/">jaredbarboza.me</a>
      </h1>
      <p class="header-description">üçï P I Z Z A is life</p>
    </div>

    <ul class="flex flex-wrap sm:w-32 w-full mt-6 md:justify-between justify-evenly">
      <li>
        <a href="/about">About</a>
      </li>
      <li>
        <a href="https://github.com/@codeimpossible">GitHub</a>
      </li>
    </ul>
  </nav>
</header>-->
      
    <div>
        <h1>Localizations in Unity: Part 2</h1>

        

        
            <span class="text-sm">üìÜ <em>Created on
                    <span datetime="Fri Aug 20 2021 00:00:00 GMT+0000 (Coordinated Universal Time)">August 20, 2021</span>.</em></span>
        

        
            <span class="pl-10 mb-2 tags">
                <span>üîñ</span>
                <a class="tag tag-inline" href="/tag/unity3d">unity3d</a><a class="tag tag-inline" href="/tag/game-development">game-development</a><a class="tag tag-inline" href="/tag/localization">localization</a>
            </span>
        

        <div class="content post">
            <p>In my <a href="/post/localization">previous post</a> I explained what localization is and why it's such an important feature for Electric Noir. I showed how I had setup my translations in a Google Spreadsheet to give basic translations for testing and allow translators access in the future.</p>
<p>In this post I'll cover how I wrote a custom importer to create Unity assets from the downloaded CSV files.</p>
<h2>Importing Localizations</h2>
<p>Having the localizations in CSV format is useful, but it's hard to do fast lookups of strings using just a CSV. I could build out a CSV parser and use that but as of Unity 2018.3 you can create custom <a href="">ScriptedImporter</a> objects that can handle specific file types and import them into the Unity Asset Database.</p>
<p>First let's start with a caveat. Custom importers can work on <em>almost</em> any file type. Importers are bound to files by their file extension, so if another importer has reserved the extension you want to use, your out of luck. Unfortunately for us this is the case as <code>*.csv</code> is registered by a built-in Unity importer.</p>
<p>Fortunately for us though, we have full control over the files we downloaded, so we can just change their extension to something else that isn't in use. I decided on using <code>*.l10n</code> as my file extension (a common short code for localization), but you can use whatever you want, just be sure to update any of the code you pull out of this series to use the your extension.</p>
<h2>Basic Importer Structure</h2>
<p>Let's start out with a basic - and empty - ScriptedImporter.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">UnityEditor</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">UnityEditor<span class="token punctuation">.</span>AssetImporters</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token namespace">GameEditor<span class="token punctuation">.</span>Importers</span> <span class="token punctuation">{</span><br><br>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ScriptedImporter</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">".l10n"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><br>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalizationImporter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ScriptedImporter</span></span> <span class="token punctuation">{</span><br>        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnImportAsset</span><span class="token punctuation">(</span><span class="token class-name">AssetImportContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Alright, this is our basic importer code. All the work is done within <code>OnImportAsset()</code>. This is where we'll get a reference to the localization file that was added or updated and use that to build out our localization assets.</p>
<h3>Data Objects</h3>
<p>Before we can import anything we'll need some objects (data containers) to hold the data we want to store. We can create these easily enough using <code>ScriptableObject</code> and classes marked with <code>[Serializable]</code>.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>RegularExpressions</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token namespace">Localization<span class="token punctuation">.</span>Data</span> <span class="token punctuation">{</span><br>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Serializable</span></span><span class="token punctuation">]</span><br>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TranslatedTextItem</span> <span class="token punctuation">{</span><br>        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> Key<span class="token punctuation">;</span><br>        <span class="token keyword">public</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>TranslatedTextValue<span class="token punctuation">></span></span> Values<span class="token punctuation">;</span><br><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> language<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">value</span> <span class="token keyword">in</span> Values<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">.</span>Language <span class="token operator">==</span> language<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">return</span> <span class="token keyword">value</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Serializable</span></span><span class="token punctuation">]</span><br>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TranslatedTextValue</span> <span class="token punctuation">{</span><br>        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> Language<span class="token punctuation">;</span><br>        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> Value<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalizationSet</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ScriptableObject</span></span> <span class="token punctuation">{</span><br><br>        <span class="token keyword">public</span> <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> Keys<span class="token punctuation">;</span><br>        <span class="token keyword">public</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>TranslatedTextItem<span class="token punctuation">></span></span> Values<span class="token punctuation">;</span><br>        <span class="token keyword">public</span> <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> SafeKeys<span class="token punctuation">;</span><br><br>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Regex</span> Cleanup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Regex</span><span class="token punctuation">(</span><span class="token string">@"[^0-9a-zA-Z]+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">public</span> <span class="token return-type class-name">TranslatedTextItem</span> <span class="token function">GetItem</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name"><span class="token keyword">int</span></span> index <span class="token operator">=</span> SafeKeys<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> index <span class="token operator">=</span> Keys<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>            <span class="token keyword">return</span> Values<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br><span class="token preprocessor property">#<span class="token directive keyword">if</span> UNITY_EDITOR</span><br>        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnValidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            SafeKeys<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Keys<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> Cleanup<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>Keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                SafeKeys<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br><span class="token preprocessor property">#<span class="token directive keyword">endif</span></span><br><span class="token punctuation">}</span></code></pre>
<p>So this shows how I plan on storing the localization data once it's imported. Each <code>*.l10n</code> file will get imported as a <code>LocalizationSet</code> containing all of the keys and their translated values (<code>TranslatedTextItem</code>). I'll also store a &quot;safe&quot; version of the key - a copy without any spaces or special characters), which can be used later on within the Unity inspector to build out a drop-down selction menu.</p>
<h2>Parsing CSV data</h2>
<p>Now we can update our importer to include these data objects and start importing the CSV data.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Regex</span> CSVParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Regex</span><span class="token punctuation">(</span><span class="token string">",(?=(?:[^\"]*\"[^\"]*\")*(?![^\"]*\"))"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnImportAsset</span><span class="token punctuation">(</span><span class="token class-name">UnityEditor<span class="token punctuation">.</span>AssetImporters<span class="token punctuation">.</span>AssetImportContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">set</span> <span class="token operator">=</span> ScriptableObject<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateInstance</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>LocalizationSet<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> keys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TranslatedTextItem<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> sourceText <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>assetPath<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">int</span></span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> line <span class="token keyword">in</span> sourceText<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">"\r\n"</span><span class="token punctuation">,</span> <span class="token string">"\r"</span><span class="token punctuation">,</span> <span class="token string">"\n"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> StringSplitOptions<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token class-name"><span class="token keyword">var</span></span> entries <span class="token operator">=</span> CSVParser<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx<span class="token operator">++</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            headers<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">continue</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>This code will pull the entries out of the CSV using a regular expression, which is definitely harder to read, but way more reliable than trying to parse the CSV ourselves. Basically, this regex says: <em>split on the comma only if that comma has zero, or an even number of quotes ahead of it</em>.</p>
<p>Also in the code above, the entries in the first row (<code>idx == 0</code>) will be added to the <code>headers</code> list.</p>
<h2>Edge Cases</h2>
<p>Next we're going to need to pull out the terms and their translations. This is where things get a little complicated because of a few edge cases. Let's explore how each of these affects the solution.</p>
<ol>
<li>What if multiple terms/phrases can have the same translation?</li>
<li>What if the translation contains quoatation marks?</li>
</ol>
<p>The first one is easy enough, we can just add multiple entries to the first column of our spread sheet like so:</p>
<pre><code>&quot;Dark, The Dark, the Void&quot;,Space.,Raum.,Espacio.
</code></pre>
<p>Google Spreadsheets will add the quotes around any text value that contains a comma, which is why we have the <code>CSVParser</code> regex, however that regex won't be reliable enough to pull out the sub entries from our first column. We'll need to create a function for that.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">GetSubEntries</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> entry<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string character">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>This takes a bit of text, splits it and returns the array of items. This is fine, but what about the quotation marks that Google inserted into the CSV data? Well that's where our second edge case comes in. And we'll create a new function to deal with this as well.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">GetSubEntries</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> text <span class="token operator">=</span> <span class="token function">CleanupText</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string character">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">CleanupText</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> text <span class="token operator">=</span> entry<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">"\""</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        text <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"\"\""</span><span class="token punctuation">,</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> text<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h2>Putting it all together</h2>
<p>Alright, so now we can parse out the multiple terms from the first column and optionally clean up any quotation marks within a given entry. So let's update our importer to use the new code and build out our localization assets.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnImportAsset</span><span class="token punctuation">(</span><span class="token class-name">UnityEditor<span class="token punctuation">.</span>AssetImporters<span class="token punctuation">.</span>AssetImportContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">set</span> <span class="token operator">=</span> ScriptableObject<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateInstance</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>LocalizationSet<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> keys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TranslatedTextItem<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> sourceText <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>assetPath<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">int</span></span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> line <span class="token keyword">in</span> sourceText<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">"\r\n"</span><span class="token punctuation">,</span> <span class="token string">"\r"</span><span class="token punctuation">,</span> <span class="token string">"\n"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> StringSplitOptions<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token class-name"><span class="token keyword">var</span></span> entries <span class="token operator">=</span> CSVParser<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx<span class="token operator">++</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            headers<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">continue</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <span class="token class-name"><span class="token keyword">var</span></span> subItems <span class="token operator">=</span> <span class="token function">GetSubEntries</span><span class="token punctuation">(</span>entries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> e <span class="token keyword">in</span> subItems<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name"><span class="token keyword">var</span></span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TranslatedTextItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Key <span class="token operator">=</span> e<span class="token punctuation">,</span> Values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TranslatedTextValue<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br>            <span class="token class-name"><span class="token keyword">int</span></span> colIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> entry <span class="token keyword">in</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name"><span class="token keyword">var</span></span> text <span class="token operator">=</span> <span class="token function">CleanupText</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">if</span> <span class="token punctuation">(</span>colIdx <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    <span class="token class-name"><span class="token keyword">var</span></span> lang <span class="token operator">=</span> headers<span class="token punctuation">[</span>colIdx<span class="token punctuation">]</span><span class="token punctuation">;</span><br>                    item<span class="token punctuation">.</span>Values<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TranslatedTextValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Language <span class="token operator">=</span> lang<span class="token punctuation">,</span> Value <span class="token operator">=</span> text <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                colIdx<span class="token operator">++</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            keys<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            values<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">set</span><span class="token punctuation">.</span>Keys <span class="token operator">=</span> keys<span class="token punctuation">;</span><br>    <span class="token keyword">set</span><span class="token punctuation">.</span>Values <span class="token operator">=</span> values<span class="token punctuation">;</span><br>    ctx<span class="token punctuation">.</span><span class="token function">AddObjectToAsset</span><span class="token punctuation">(</span><span class="token string">"LocalizationSet"</span><span class="token punctuation">,</span> <span class="token keyword">set</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ctx<span class="token punctuation">.</span><span class="token function">SetMainObject</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>With this saved in our project we can drag a new <code>*.l10n</code> file into our project and Unity will automatically call our importer which will convert it to a <code>LocalizationSet</code>! Once all that is done, you should see something similar to the images below.</p>
<img src="/electricnoir/LocalizationSetImported.png" />
<p>That wraps up part 2, in the next post I'll show how we can bind a localization to a GameObject and get the translated value at runtime.</p>
<p>Until next time! You can always shoot me your thoughts on <a href="https://www.twitter.com/codeimpossible">twitter.</a></p>

        </div>
            <span style="float: left">
                <span class="uppercase text-xs mt-6">Previous</span>
                <span class="font-bold">
                    <a href="/post/Localizations-in-Unity-Part-1/">Localizations in Unity: Part 1</a>
                </span>
            </span>
        
        
    </div>

    </main>
    <footer>
  <div class="container mx-auto max-w-3xl flex-grow">
    <div class="grid grid-cols-2 gap-4">
      <div>
        <p class="block text-center text-sm mb-6">
        Release: <a href="https://github.com/codeimpossible/jaredbarboza.me/commit/89db75ec698ec619fd4a43fe0dd1ec17745ba0e5">89db75ec</a>
        &copy;
        <a target="_blank" href="https://jaredbarboza.me">
          Jared Barboza
        </a> 2020.
        </p>
      </div>
      <div style="text-align: right">
        <ul>
          <li><a href="/license/">License</a></li>
          <li><a href="https://github.com/codeimpossible">GitHub</a></li>
          <li><a href="https://twitter.com/codeimpossible">Twitter</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
    <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
    <script src="/assets/main.bundle.js"></script>
  </body>
</html>
